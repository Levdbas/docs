<!DOCTYPE html>
<html lang="en">
<head>
	<title>Performance/Caching</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

	
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />

	
    <link rel="stylesheet" href="https://timber.github.io/docs/css/styles.css?bbb4a34691cef083c31eb7d1af61a243">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel="stylesheet">

    
    <link rel="icon" href="https://timber.github.io/docs/favicons/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://timber.github.io/docs/favicons/apple-touch-icon-57x57.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://timber.github.io/docs/favicons/apple-touch-icon-114x114.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://timber.github.io/docs/favicons/apple-touch-icon-72x72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://timber.github.io/docs/favicons/apple-touch-icon-144x144.png" />
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://timber.github.io/docs/favicons/apple-touch-icon-60x60.png" />
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://timber.github.io/docs/favicons/apple-touch-icon-120x120.png" />
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://timber.github.io/docs/favicons/apple-touch-icon-76x76.png" />
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://timber.github.io/docs/favicons/apple-touch-icon-152x152.png" />
	<link rel="icon" type="image/png" href="https://timber.github.io/docs/favicons/favicon-196x196.png" sizes="196x196" />
	<link rel="icon" type="image/png" href="https://timber.github.io/docs/favicons/favicon-96x96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="https://timber.github.io/docs/favicons/favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="https://timber.github.io/docs/favicons/favicon-16x16.png" sizes="16x16" />
	<link rel="icon" type="image/png" href="https://timber.github.io/docs/favicons/favicon-128.png" sizes="128x128" />
	<meta name="application-name" content="Timber Docs"/>
	<meta name="msapplication-TileColor" content="#FFFFFF" />
	<meta name="msapplication-TileImage" content="https://timber.github.io/docs/favicons/mstile-144x144.png" />
	<meta name="msapplication-square70x70logo" content="https://timber.github.io/docs/favicons/mstile-70x70.png" />
	<meta name="msapplication-square150x150logo" content="https://timber.github.io/docs/favicons/mstile-150x150.png" />
	<meta name="msapplication-wide310x150logo" content="https://timber.github.io/docs/favicons/mstile-310x150.png" />
	<meta name="msapplication-square310x310logo" content="https://timber.github.io/docs/favicons/mstile-310x310.png" />

</head>


<body>

<header class="header">
    <a class="logo-link" href="https://timber.github.io/docs/">
        <div id="logo">
            <img src="https://timber.github.io/docs/images/timberlogo.svg" alt="Timber" style="width:105px;height:30px;border:0">
        </div>
    </a>

	<div class="search-container">
		<label for="search" class="search-label">Search</label>
		<input type="search" name="search" class="search" id="search">
	</div>

    <nav class="nav nav--top" id="nav-top">
        <ul>
            <li>
                <a href="http://upstatement.com/timber/"
                   target="_blank" rel="noreferrer noopener">Timber Homepage</a>
            </li>
            <li>
                <a href="http://twig.sensiolabs.org/doc/templates.html"
                   target="_blank" rel="noreferrer noopener">Twig Documentation</a>
            </li>
            <li><a href="http://code.tutsplus.com/series/kick-start-wordpress-development-with-twig--cms-974"
                   target="_blank" rel="noreferrer noopener">Getting Started Tutorials</a>
            </li>
            <li>
                <a href="https://github.com/timber/timber"
                   target="_blank" rel="noreferrer noopener">
                    <img src="https://timber.github.io/docs/images/Github.png" alt="Star on Github" style="width:29px;height:29px;border:0">
                </a>
            </li>
        </ul>
    </nav>
</header>

<aside class="sidebar">
    <nav id="nav" class="nav nav--main">
        <ul class="nav__items nav__items--level-0">
        
        
            <li class="nav__item nav__item--level-0"><a class="nav__link nav__link--level-0" href="/docs/getting-started/">Getting Started</a>
            
                <ul class="nav__items nav__items--level-1">
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/getting-started/setup/">Setup</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/getting-started/theming/">Theming</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/getting-started/twig-tools/">Twig Tools</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/getting-started/video-tutorials/">Video Tutorials</a></li>
                
                </ul>
            
            </li>
        
            <li class="nav__item nav__item--level-0 nav__item--current-ancestor"><a class="nav__link nav__link--level-0" href="/docs/guides/">Guides</a>
            
                <ul class="nav__items nav__items--level-1">
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/acf-cookbook/">ACF Cookbook</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/cheatsheet/">Cheatsheet</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/custom-page-templates/">Custom Page Templates</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/debugging/">Debugging</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/escapers/">Escapers</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/extending-timber/">Extending Timber</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/filters/">Filters</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/functions/">Functions</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/cookbook-images/">Image Cookbook</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/internationalization/">Internationalization</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/menus/">Menus</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/pagination/">Pagination</a></li>
                
                    <li class="nav__item nav__item--level-1 nav__item--current"><a class="nav__link nav__link--level-1" href="/docs/guides/performance/">Performance/Caching</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/routing/">Routing</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/sidebars/">Sidebars</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/template-locations/">Template Locations</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/testing/">Testing</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/cookbook-text/">Text Cookbook</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/cookbook-twig/">Twig Cookbook</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/woocommerce/">WooCommerce</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/guides/wp-integration/">WordPress Integration</a></li>
                
                </ul>
            
            </li>
        
            <li class="nav__item nav__item--level-0"><a class="nav__link nav__link--level-0" href="/docs/reference/">Reference</a>
            
                <ul class="nav__items nav__items--level-1">
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-archives/">Timber\Archives</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-comment/">Timber\Comment</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-helper/">Timber\Helper</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-image/">Timber\Image</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-imagehelper/">Timber\ImageHelper</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-menu/">Timber\Menu</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-menuitem/">Timber\MenuItem</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-pagination/">Timber\Pagination</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-post/">Timber\Post</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-postpreview/">Timber\PostPreview</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-postquery/">Timber\PostQuery</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-site/">Timber\Site</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-term/">Timber\Term</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-texthelper/">Timber\TextHelper</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-theme/">Timber\Theme</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber/">Timber\Timber</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-urlhelper/">Timber\URLHelper</a></li>
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/reference/timber-user/">Timber\User</a></li>
                
                </ul>
            
            </li>
        
            <li class="nav__item nav__item--level-0"><a class="nav__link nav__link--level-0" href="/docs/upgrade-guides/">Upgrade Guides</a>
            
                <ul class="nav__items nav__items--level-1">
                
                    <li class="nav__item nav__item--level-1"><a class="nav__link nav__link--level-1" href="/docs/upgrade-guides/1.0/">Upgrade to 1.0</a></li>
                
                </ul>
            
            </li>
        
        </ul>
    </nav>
</aside>


<main>
    
	<article>
		<h1>Performance/Caching</h1>

		<aside class="toc">
			<h2 class="heading-4 toc__title">Contents of this page</h2>
			<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#tl-dr">tl;dr</a></li>
<li><a href="#cache-everything">Cache Everything</a></li>
<li><a href="#cache-the-entire-twig-file-and-data">Cache the Entire Twig File and Data</a>
<ul>
<li><a href="#set-cache-mode">Set cache mode</a></li>
</ul></li>
<li><a href="#cache-parts-of-the-twig-file-and-data">Cache <em>Parts</em> of the Twig File and Data</a>
<ul>
<li><a href="#extra-timberkeygeneratorinterface">Extra: TimberKeyGeneratorInterface</a></li>
</ul></li>
<li><a href="#cache-the-twig-file-but-not-the-data">Cache the Twig File (but not the data)</a></li>
<li><a href="#cache-the-php-data">Cache the PHP data</a></li>
<li><a href="#measuring-performance">Measuring Performance</a></li>
</ul></li>
</ul>
</nav>
		</aside>

		<div class="content-container">
			<div class="content">
				

<p>Timber, especially in conjunction with WordPress and Twig, offers a variety of caching strategies to optimize performance. Here’s a quick rundown of some of the options, ranked in order of most-broad to most-focused.</p>

<h2 id="tl-dr">tl;dr</h2>

<p>In my tests with Debug Bar, Timber has no measurable performance hit. Everything compiles to PHP. @fabpot has an <a href="http://fabien.potencier.org/article/34/templating-engines-in-php">overview of the performance costs on his blog</a> (scroll down to the table).</p>

<h2 id="cache-everything">Cache Everything</h2>

<p>You can still use plugins like <a href="https://wordpress.org/plugins/w3-total-cache/">W3 Total Cache</a> in conjunction with Timber. In most settings, this will <em>skip</em> the Twig/Timber layer of your files and serve static pages via whatever mechanism the plugin or settings dictate.</p>

<h2 id="cache-the-entire-twig-file-and-data">Cache the Entire Twig File and Data</h2>

<p>When rendering, use the <code>$expires</code> argument in <a href="/reference/timber/#render"><code>Timber::render</code></a>. For example:</p>

<pre><code class="language-php">&lt;?php
$context['posts'] = Timber::get_posts();
Timber::render( 'index.twig', $context, 600 );
</code></pre>

<p>In this example, Timber will cache the template for 10 minutes (600 / 60 = 10). But here’s the cool part: Timber hashes the fields in the view context. This means that <strong>as soon as the data changes, the cache is automatically invalidated</strong>. Yay!</p>

<p>This method is very effective, but crude - the whole template is cached. So if you have any context dependent sub-views (eg. current user), this mode won’t do.</p>

<h3 id="set-cache-mode">Set cache mode</h3>

<p>As a fourth parameter for <a href="/reference/timber/#render">Timber::render()</a>, you can set the <code>$cache_mode</code>.</p>

<pre><code class="language-php">&lt;?php
Timber::render( $filenames, $data, $expires, $cache_mode );
</code></pre>

<p>The following cache modes are available:</p>

<table>
<thead>
<tr>
<th>Mode</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>Timber\Loader::CACHE_NONE</code></td>
<td>Disable caching</td>
</tr>

<tr>
<td><code>Timber\Loader::CACHE_OBJECT</code></td>
<td>WP Object Cache</td>
</tr>

<tr>
<td><code>Timber\Loader::CACHE_TRANSIENT</code></td>
<td>Transients</td>
</tr>

<tr>
<td><code>Timber\Loader::CACHE_SITE_TRANSIENT</code></td>
<td>Network wide transients</td>
</tr>

<tr>
<td><code>Timber\Loader::CACHE_USE_DEFAULT</code></td>
<td>Use whatever caching mechanism is set as the default for <code>Timber\Loader</code>, the default is <code>CACHE_TRANSIENT</code>.</td>
</tr>
</tbody>
</table>

<h2 id="cache-parts-of-the-twig-file-and-data">Cache <em>Parts</em> of the Twig File and Data</h2>

<p>This method implements the <a href="https://github.com/asm89/twig-cache-extension">Twig Cache Extension</a>. It adds the cache tag, for use in templates. Best shown by example:</p>

<pre><code class="language-twig">{% cache 'index/content' posts %}
    {% for post in posts %}
        {% include ['tease-'~post.post_type~'.twig', 'tease.twig'] %}
    {% endfor %}
{% endcache %}
</code></pre>

<p><code>'index/content'</code> will be used as annotation (label) for the cache, while <code>posts</code> will be encoded with all its public fields. You can use anything for the label (&ldquo;foo&rdquo;, &ldquo;elephant&rdquo;, &ldquo;single-posts&rdquo;, whatever).</p>

<p>The mechanism behind it is the same as with render - the cache key is determined based on a hash of the object/array passed in (in the above example posts).</p>

<p>The cache method used is always the default mode, set using the bespoke filter (by default, transient cache).</p>

<p>This method allows for very fine-grained control over what parts of templates are being cached and which are not. When applied on resource-intensive sections, the performance difference is huge.</p>

<p>In your cache, the eventual key will be:</p>

<pre><code class="language-php">&lt;?php
$annotation . '__GCS__' . $key
</code></pre>

<p>That is in this scenario:</p>

<pre><code class="language-php">&lt;?php
'index/content__GCS__' . md5( json_encode( $context['post'] ) )
</code></pre>

<h3 id="extra-timberkeygeneratorinterface">Extra: TimberKeyGeneratorInterface</h3>

<p>Instead of hashing a whole object, you can specify the cache key in the object itself. If the object implements <code>TimberKeyGeneratorInterface</code>, it can pass a unique key through the method <code>get_cache_key</code>. That way a class can for example simply pass <code>'last_updated'</code> as the unique key.
If arrays contain the key <code>_cache_key</code>, that one is used as cache key.</p>

<p>This may save yet another few processor cycles.</p>

<h2 id="cache-the-twig-file-but-not-the-data">Cache the Twig File (but not the data)</h2>

<p>Every time you render a <code>.twig</code> file, Twig compiles all the HTML tags and variables into a big, nasty blob of function calls and echo statements that actually gets run by PHP. In general, this is pretty efficient. However, you can cache the resulting PHP blob by turning on Twig’s cache via:</p>

<p><strong>functions.php</strong></p>

<pre><code class="language-php">&lt;?php
if ( class_exists( 'Timber' ) ){
	Timber::$cache = true;
}
</code></pre>

<p>You can look in your your <code>/wp-content/plugins/timber/twig-cache</code> directory to see what these files look like.</p>

<p>This does not cache the <em>contents</em> of the variables. This is recommended as a last-step in the production process. Once enabled, any change you make to a <code>.twig</code> file (just tweaking the HTML for example) will not go live until the cache is flushed.</p>

<h2 id="cache-the-php-data">Cache the PHP data</h2>

<p>Sometimes the most expensive parts of the operations are generating the data needed to populate the twig template. You can of course use WordPress’s default <a href="http://codex.wordpress.org/Transients_API">Transient API</a> to store this data.</p>

<p>You can also use some <a href="http://en.wikipedia.org/wiki/Syntactic_sugar">syntactic sugar</a> to make the checking/saving/retrieving of transient data a bit easier:</p>

<p><strong>home.php</strong></p>

<pre><code class="language-php">&lt;?php

$context = Timber::get_context();

$context['main_stories'] = TimberHelper::transient( 'main_stories', function(){
    $posts = Timber::get_posts();

    // As an example, do something expensive with these posts
    $extra_teases = get_field( 'my_extra_teases', 'options' );

    foreach( $extra_teases as &amp;$tease ){
        $tease = new Timber\Post( $tease );
    }

    $main_stories = array();
    $main_stories['posts'] = $posts;
    $main_stories['extra_teases'] = $extra_teases;

    return $main_stories;
}, 600 );

Timber::render( 'home.twig', $context );
</code></pre>

<p>Here <code>main_stories</code> is a totally made-up variable. It could be called <code>foo</code>, <code>bar</code>, <code>elephant</code>, etc.</p>

<h2 id="measuring-performance">Measuring Performance</h2>

<p>Some tools like Debug Bar may not properly measure performance because its data (as in, the actual HTML it’s generating to tell you the timing, number of queries, etc.) is swept-up by the page’s cache.</p>

<p>Timber provides some quick shortcuts to measure page timing. Here’s an example of them in action:</p>

<p><strong>single.php</strong></p>

<pre><code class="language-php">&lt;?php
// This generates a starting time
$start = TimberHelper::start_timer();

$context = Timber::get_context();
$context['post'] = Timber::get_post();
$context['whatever'] = get_my_foo();

Timber::render( 'single.twig', $context, 600 );

// This reports the time diff by passing the $start time
echo TimberHelper::stop_timer( $start);
</code></pre>

			</div>
		</div>
	</article>

</main>



<script src="https://timber.github.io/docs/js/highlight.pack.js" defer></script>
<script src="https://timber.github.io/docs/js/scripts.js?18bf6c2843a868bd886e268277fd2fa2" defer></script>


<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: '4907f57b267887b1da360de600656085',
indexName: 'timber',
inputSelector: '#search',
debug: false 
});
</script>

</body>
</html>
